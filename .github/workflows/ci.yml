# Do not edit this file directly. It is generated by https://deno.land/x/fluent_github_actions

name: ci
on:
  push:
    branches:
      - main
jobs:
  tasks:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Fluent CI
        uses: fluentci-io/setup-fluentci@v5
        with:
          wasm: true
          plugin: packer
          args: |
            setup
      - name: export VM_ID
        run: |
          fluentci run --wasm rust setup
          cargo install moniker-rs
          export VM_ID=`[ $(( RANDOM % 2  )) -eq 0 ] && moniker-cli moby || moniker-cli animal`
          echo "VM_ID=$VM_ID" >> $GITHUB_ENV
      - name: build VM image
        run: |
          brew install wget qemu cdrtools ansible tart
          wget -O "$QCOW2_IMAGE" "$URL" || true
          qemu-img convert -p -f qcow2 -O raw "$QCOW2_IMAGE" "$RAW_IMAGE"
          echo "local-hostname: $VM_NAME" > cloud-init/meta-data
          cat "$USER_DATA_FIXTURE" > cloud-init/user-data
          mkisofs -output cloud-init.iso -volid cidata -joliet -rock cloud-init/
          packer init .
          tart create --linux "$VM_ID"
          mv "$RAW_IMAGE" ~/.tart/vms/"$VM_ID"/disk.img
          packer build -var vm_name="$VM_ID" .
          tart get "$VM_ID"
        env:
          VM_NAME: "ubuntu"
          VM_RELEASE: "22.04"
          VM_ARCH: "arm64"
          URL: https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-arm64.img
          USER_DATA_FIXTURE: "cloud-init/user-data.distro-with-admin-group"
          LATEST: latest
          QCOW2_IMAGE: image.qcow2
          RAW_IMAGE: image.raw
